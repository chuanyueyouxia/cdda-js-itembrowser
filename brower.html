<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" type="text/css" href="style.css" />
  <script src="jquery-3.0.0.min.js"></script>
  <script type="text/javascript" src="data.js"></script>
  <script type="text/javascript" src="cdda.js"></script>
  <script type="text/javascript" src="JsonFlagClass.js"></script>
  <script type="text/javascript" src="MaterialClass.js"></script>
  <script type="text/javascript" src="ItemClass.js"></script>
  <script type="text/javascript" src="RequirementClass.js"></script>
  <script type="text/javascript" src="RecipeClass.js"></script>
  <script type="text/javascript">
    var key_id = "";
    var mode = "show_item";

    function conv_to_array(obj) {
      if (!Array.isArray(obj)) {
        var new_array = [obj];
        return new_array;
      }
      return obj;
    }

    function item_data_html(id) {
      var string_html = "";
      item_data = new ItemClass(id);
      console.log(item_data);

      string_html += item_data.dumpBasicData() + '<br>';
      if (item_data.isArmor()) {
        string_html += item_data.dumpArmorData() + '<br>';
      }
      if (item_data.isGun()) {
        string_html += item_data.dumpGunData() + '<br>';
      }
      string_html += item_data.getDescription() + '<br>';

      string_html += "</p>";
      return string_html;
    }

    function link_to_item(string, id) {
      return '<a href=javascript:select_item("' + id + '")>' + string + '</a>';
    }

    function item_recipe_html(id) {
      var string_html = "<h3>レシピ</h3>";
      var recipe_list = new RecipeListClass(id);
      string_html += "<p>";
      if (!recipe_list.getRecipe(0)) {
        string_html += "レシピはありません。"
      } else {
        for (var recipe_num = 0; recipe_list.getRecipe(recipe_num); recipe_num++) {
          string_html += "<h4>レシピ" + (recipe_num + 1) + "</h4>";
          var recipe_data = recipe_list.getRecipe(recipe_num);
          string_html += "適用スキル: " + recipe_data.getSkillUsed() + "<br>";
          string_html += "必要スキル: ";
          if (recipe_data.getSkillsRequired()) {
            for (var r of recipe_data.getSkillsRequired()) {
              if (r[0]) {
                string_html += r[0] + "(" + r[1] + "), ";
              }
            }
          }
          string_html += "<br>";
          string_html += "難易度: " + recipe_data.getDifficulty() + "<br>";
          string_html += "完了まで " + (recipe_data.getTime() / 1000) + " 分<br>";
          for (var q of recipe_data.getQualities()) {
            string_html += "レベル " + q.level + " の " + q.id + " 性能<br>";
          }
          for (var t of recipe_data.getTools()) {
            string_html += "&gt;";
            for (var i = 0; i < t.length; ++i) {
              if (t[i][0]) {
                console.log(t[i][0]);
                var item = new ItemClass(t[i][0]);
                var charges = t[i][1];
                string_html += link_to_item(item.getName(), item.getId());
                string_html += charges != -1 ? "(充填量: " + charges + ")" : "";
                if (t.length - 1 > i) {
                  string_html += " または ";
                } else {
                  string_html += "<br>";
                }
              }
            }
          }
          for (var c of recipe_data.getComponents()) {
            string_html += "&gt;";
            for (var i = 0; i < c.length; ++i) {
              if (c[i][0]) {
                var item = new ItemClass(c[i][0]);
                var charges = c[i][1];
                string_html += charges + " 個の " + link_to_item(item.getName(), item.getId());
                if (c.length - 1 > i) {
                  string_html += " または ";
                } else {
                  string_html += "<br>";
                }
              }
            }
          }
          for (var b of recipe_data.getBookLearn()) {
            var item = new ItemClass(b[0]);
            string_html += link_to_item(item.getName(), item.getId()) + " から適用スキルがレベル " + b[1] + " で習得します。<br>";
          }
          if (recipe_data.getAutolearn()) {
            string_html += "このレシピは必要スキルを満たしたときに自動で習得します。<br>";
          }
        }
      }
      string_html += "</p>";
      return string_html;
    }

    function update_data() {
      $('#Right_area').empty();
      if (mode == "show_item") {
        var item_data = new ItemClass(key_id);
        var recipe_list = new RecipeListClass(key_id);
        console.log(JSON.stringify(item_data));
        console.log(JSON.stringify(recipe_list));

        $('#Right_area').append(item_data_html(key_id));
        $('#Right_area').append(item_recipe_html(key_id));
        $('#Right_area').append("<h3>JSON</h3>");
        $('#Right_area').append("<h4>Item</h3>");
        $('#Right_area').append(JSON.stringify(item_data.getJson()));
        $('#Right_area').append("<h4>Recipes</h3>");
        var i = 0;
        r = recipe_list.getRecipe(i);
        while (r) {
          $('#Right_area').append(JSON.stringify(r.getJson()));
          i++;
          r = recipe_list.getRecipe(i);
        }
      }
    }

    function select_item(key) {
      key_id = key;
      update_data();
    }

    function search_data() {
      var key = search.textbox.value;
      $('#search_result').empty()
      for (var item of items) {
        if (item.name && item.id && key) {
          if (item.name.indexOf(key) != -1) {
            $('#search_result').append(
              '<a href=javascript:select_item("' + item.id + '")>' + item.name + '</a><br>'
            );
          }
        }
      }
      for (var item of mod_items) {
        if (item.name && item.id && key) {
          if (item.name.indexOf(key) != -1) {
            $('#search_result').append(
              '<a href=javascript:select_item("' + item.id + '")>[MOD]' + item.name + '</a><br>'
            );
          }
        }
      }
    }
  </script>
  <script type="text/javascript">
  </script>
</head>

<body>

  <div id="Left_area">
    <form name="search">
      <input type="text" name="textbox" onkeyup="search_data()" placeholder="検索キーワードを入力してください">
    </form>
    <div id="search_result">
    </div>
  </div>
  <div id="Right_area">
  </div>
</body>

</html>